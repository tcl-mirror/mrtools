// vim:set syntax=asciidoc:

= Micca Run Time Testing

== Singular Associations

[source,c]
----
<<test suites>>=
{"one to one associations", NULL, NULL, NULL, NULL, oneToOneAssocSuiteTests},
----

[source,c]
----
<<suite tests>>=
<<one to one associations suite tests>>

<<one to one associations suite tests>>=
static CU_TestInfo oneToOneAssocSuiteTests[] = {
    <<one to one associations test cases>>
    CU_TEST_INFO_NULL,
} ;
----

=== One to One

["aafigure"]
----
+---+            +---+
|   |1    R1    1|   |
| A +------------+ B |
|   |            |   |
+---+            +---+
----

----
<<test domain configuration>>=
class A {
    attribute count int
}

class B {
    attribute count int
}

association R1 A 1--1 B

<<test domain population>>=
class A {
    allocate 2
}

class B {
    allocate 2
}
----

----
<<test domain configuration>>=
domainop void oneToOne {} {
    <%B create bref1 count 1%>
    <%A create aref1 count 1 R1 bref1%>             // <1>

    <%instance aref1 findOneRelated bfound R1%>     // <2>
    CU_ASSERT(bfound->count == 1) ;
    <%instance bref1 findOneRelated afound ~R1%>
    CU_ASSERT(afound->count == 1) ;

    <%B create bref2 count 2%>                      // <3>
    <%R1 swap aref1 bref2%>

    <%instance aref1 findOneRelated bfound R1%>     // <4>
    CU_ASSERT(bfound->count == 2) ;
    <%instance bref2 findOneRelated afound ~R1%>
    CU_ASSERT(afound->count == 1) ;

    <%instance bref1 findOneRelated afound ~R1%>    // <5>
    CU_ASSERT_PTR_NULL(afound) ;

    <%R1 swap aref1 bref2%>                         // <6>
    <%instance aref1 findOneRelated bfound R1%>
    CU_ASSERT(bfound->count == 2) ;
    <%instance bref2 findOneRelated afound ~R1%>
    CU_ASSERT(afound->count == 1) ;

    <%instance bref1 delete%>                       // <7>

    <%instance aref1 delete%>                       // <8>
    <%instance bref2 findOneRelated afound ~R1%>
    CU_ASSERT_PTR_NULL(afound) ;

    <%instance bref2 delete%>                       // <9>
}
----
<1> Create a related pair.
<2> Check the navigation of R1 to make sure we get the right instance.
<3> Create a new related pair by swaping in a new instance.
<4> Check we are navigating to the correct instances.
<5> The previously related instance is now "dangling" and should
havigate to nowhere.
<6> Check that swapping in the same instance does nothing.
<7> Delete the dangling instance.
<8> Delete the refering instance and check that the referenced
instance now navigates nowhere.
<9> Clean up the dangling instance to prevent referential integrity violation.

[source,c]
----
<<one to one associations test cases>>=
{"1--1", genTest_OneToOne},

<<test functions>>=
static void
genTest_OneToOne(void)
{
    gendomain_oneToOne() ;

    bool didevent = mrt_DispatchSingleEvent() ;
    CU_ASSERT_FALSE(didevent) ;
}
----

=== One C to One

["aafigure"]
----
+---+            +---+
|   |?    R1    1|   |
| C +------------+ D |
|   |            |   |
+---+            +---+
----

[source,tcl]
----
<<test domain configuration>>=
class C {
    attribute count int
}

class D {
    attribute count int
}

association R2 C ?--1 D

<<test domain population>>=
class C {
    allocate 2
}

class D {
    allocate 4
}
----

----
<<test domain configuration>>=
domainop void oneCToOne {} {
    <%D create dref1 count 1%>
    <%C create cref1 count 1 R2 dref1%>

    <%instance cref1 findOneRelated dfound R2%>
    CU_ASSERT(dfound->count == 1) ;

    <%instance dref1 findOneRelated cfound ~R2%>
    CU_ASSERT(cfound->count == 1) ;

    <%D create dref2 count 2%>
    <%instance dref2 findOneRelated cfound ~R2%>
    CU_ASSERT_PTR_NULL(cfound) ;

    <%D create dref3 count 3%>
    <%R2 swap cref1 dref3%>

    <%instance cref1 findOneRelated dfound R2%>
    CU_ASSERT(dfound->count == 3) ;

    <%instance dref3 findOneRelated cfound ~R2%>
    CU_ASSERT(cfound->count == 1) ;
}
----

[source,c]
----
<<one to one associations test cases>>=
{"?--1", genTest_OneCToOne},

<<test functions>>=
static void
genTest_OneCToOne(void)
{
    gendomain_oneCToOne() ;

    bool didevent = mrt_DispatchSingleEvent() ;
    CU_ASSERT_FALSE(didevent) ;
}
----

=== One to One Reflexive

["aafigure"]
----
     +--------+ R3
     |        |
    1|        |
+----+----+   |
|E        |   |
+---------+ 1 |
|count    +---+
|         |
+---------+
----

[source,tcl]
----
<<test domain configuration>>=
class E {
    attribute count int
}

association R3 E 1--1 E

<<test domain population>>=
class E {
    allocate 6
}
----

----
<<test domain configuration>>=
domainop void oneToOneReflexive {} {
    <%E create eref1 count 1 R3 eref1%>
    <%E create eref2 count 2 R3 eref2%>
    <%E create eref3 count 3 R3 eref3%>

    <%R3 swap eref1 eref2%>
    <%R3 swap eref2 eref3%>
    <%R3 swap eref3 eref1%>

    <%instance eref1 findOneRelated efound R3%>
    CU_ASSERT(efound->count == 2) ;
    <%instance eref2 findOneRelated efound R3%>
    CU_ASSERT(efound->count == 3) ;
    <%instance eref3 findOneRelated efound R3%>
    CU_ASSERT(efound->count == 1) ;

    <%instance eref1 findOneRelated efound ~R3%>
    CU_ASSERT(efound->count == 3) ;
    <%instance eref2 findOneRelated efound ~R3%>
    CU_ASSERT(efound->count == 1) ;
    <%instance eref3 findOneRelated efound ~R3%>
    CU_ASSERT(efound->count == 2) ;

    <%instance eref2 delete%>
    <%R3 swap eref1 eref3%>
    <%instance eref1 findOneRelated efound R3%>
    CU_ASSERT(efound->count == 3) ;
    <%instance eref3 findOneRelated efound R3%>
    CU_ASSERT(efound->count == 1) ;
    <%instance eref1 findOneRelated efound ~R3%>
    CU_ASSERT(efound->count == 3) ;
    <%instance eref3 findOneRelated efound ~R3%>
    CU_ASSERT(efound->count == 1) ;
}
----

[source,c]
----
<<one to one associations test cases>>=
{"1--1 reflexive", genTest_OneToOneReflexive},

<<test functions>>=
static void
genTest_OneToOneReflexive(void)
{
    gendomain_oneToOneReflexive() ;

    bool didevent = mrt_DispatchSingleEvent() ;
    CU_ASSERT_FALSE(didevent) ;
}
----

=== One to One Associative

["aafigure"]
----
+---------+              +---------+
|F        |              |G        |
+---------+1     R4     1+---------+
|count    +-------+------+count    |
|         |       |      |         |
+---------+       |      +---------+
             +----+----+
             |"R4assoc"|
             +---------+
             |         |
             +---------+
----

----
<<test domain configuration>>=
class F {
    attribute count int
}

class G {
    attribute count int
}

class R4assoc

association R4 -associator R4assoc F 1--1 G

<<test domain population>>=
class F {
    allocate 4
}

class G {
    allocate 4
}

class R4assoc {
    allocate 4
}
----

----
<<test domain configuration>>=
domainop void oneToOneAssoc {} {
    <%F create fref1 count 1%>
    <%G create gref1 count 1%>
    <%R4assoc create r4ref1 R4 {F fref1 G gref1}%>

    <%instance fref1 findOneRelated gfound R4%>
    CU_ASSERT(gfound->count == 1) ;
    <%instance gref1 findOneRelated ffound ~R4%>
    CU_ASSERT(ffound->count == 1) ;

    <%instance r4ref1 delete%>

    <%R4assoc create r4ref2 R4 {F fref1 G gref1}%>

    <%instance fref1 findOneRelated gfound R4%>
    CU_ASSERT(gfound->count == 1) ;
    <%instance gref1 findOneRelated ffound ~R4%>
    CU_ASSERT(ffound->count == 1) ;

    <%G create gref2 count 2%>
    <%R4 swap r4ref2 gref2%>

    <%instance fref1 findOneRelated gfound R4%>
    CU_ASSERT(gfound->count == 2) ;
    <%instance gref2 findOneRelated ffound ~R4%>
    CU_ASSERT(ffound->count == 1) ;

    <%R4 swap r4ref2 gref1%>
    <%instance fref1 findOneRelated gfound R4%>
    CU_ASSERT(gfound->count == 1) ;
    <%instance gref1 findOneRelated ffound ~R4%>
    CU_ASSERT(ffound->count == 1) ;

    <%instance gref2 delete%>
}
----

[source,c]
----
<<one to one associations test cases>>=
{"1--1 associative", genTest_OneToOneAssoc},

<<test functions>>=
static void
genTest_OneToOneAssoc(void)
{
    gendomain_oneToOneAssoc() ;

    bool didevent = mrt_DispatchSingleEvent() ;
    CU_ASSERT_FALSE(didevent) ;
}
----

== CUnit Setup

[source,c]
----
<<micca_gen_test.c>>=
#include "micca_rt.h"
#include <stdlib.h>
#include <setjmp.h>
#include <CUnit/CUnit.h>
#include <CUnit/Basic.h>

#include "gendomain.h"

<<test functions>>

<<suite tests>>

static CU_SuiteInfo suites[] = {
    <<test suites>>
    CU_SUITE_INFO_NULL,
} ;

int
main(
    int argc,
    char **argv)
{
    mrt_Initialize() ;

    CU_initialize_registry() ;

    CU_register_suites(suites) ;

    CU_basic_set_mode(CU_BRM_VERBOSE) ;
    CU_basic_run_tests() ;

    const CU_pFailureRecord failures = CU_get_failure_list() ;
    CU_basic_show_failures(failures) ;

    puts("") ;

    CU_cleanup_registry() ;
}
----

== Test Domain

[source,tcl]
----
<<gendomain.micca>>=
domain gendomain {
    prologue {
        #include <CUnit/CUnit.h>
    }

    <<test domain configuration>>
}
population gendomain {
    <<test domain population>>
}
----
